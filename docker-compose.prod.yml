# 프로덕션 환경용 Docker Compose 설정
# EC2 등 클라우드 서버에서 사용

services:
  # MariaDB 데이터베이스 (MySQL 호환, 더 가벼움)
  mysql:
    image: mariadb:10.11
    container_name: mealcheck-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-changeme}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-mealcheck}
      MYSQL_USER: ${MYSQL_USER:-mealcheck}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-changeme}
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
      - ./scripts/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - mealcheck-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-changeme}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Spring Boot 백엔드
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: mealcheck-backend
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-prod}
      DB_URL: jdbc:mysql://mysql:3306/${MYSQL_DATABASE:-mealcheck}?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Seoul&characterEncoding=UTF-8
      DB_USERNAME: ${MYSQL_USER:-mealcheck}
      DB_PASSWORD: ${MYSQL_PASSWORD:-changeme}
      # JWT 시크릿 (Base64 인코딩된 문자열)
      JWT_SECRET: ${JWT_SECRET:-change_me_jwt_secret}
      # 관리자/데모 관리자 비밀번호 (환경 변수로 주입, 없으면 placeholder 사용)
      APP_ADMIN_PASSWORD: ${APP_ADMIN_PASSWORD:-change_me_admin_password}
      APP_DEMO_ADMIN_PASSWORD: ${APP_DEMO_ADMIN_PASSWORD:-change_me_demo_password}
    ports:
      - "8080:8080"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - mealcheck-network
    restart: unless-stopped
    # 메모리 과사용으로 인한 OOM 방지 (Docker Swarm 사용 시 적용)
    deploy:
      resources:
        limits:
          memory: 512m

  # React 프론트엔드
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        # 프로덕션에서는 /api로 backend에 프록시 (nginx.conf 참고)
        REACT_APP_API_URL: ${REACT_APP_API_URL:-/api}
    container_name: mealcheck-frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    networks:
      - mealcheck-network
    restart: unless-stopped

networks:
  mealcheck-network:
    driver: bridge

volumes:
  mysql-data:
    driver: local

